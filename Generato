#!/bin/bash

# Generato Script (c) 2023 Liwei Ji
# A script to process *.wl files, generate corresponding output files, and clean up trailing spaces.

[[ "$QUIET" != "1" ]] && echo "Generato (c) 2023 Liwei Ji"

# Function to display help message
show_help() {
  echo "USAGE:"
  echo "  Generato <file1.wl> [file2.wl] ..."
  echo
  echo "DESCRIPTION:"
  echo "  Processes the specified Wolfram Language (*.wl) files using wolframscript."
  echo "  Removes trailing spaces from generated output files (.hxx, .cxx, .c, .h)."
  echo
  echo "EXAMPLES:"
  echo "  Generato C3GH_set_profile_ADM.wl"
  echo "  Generato file1.wl file2.wl"
}

# Check for help flag or no arguments
if [[ "$1" == "-h" || "$1" == "--help" || -z "$1" ]]; then
  show_help
  exit 0
fi

# Check if wolframscript is installed
if ! command -v wolframscript &> /dev/null; then
  echo "Error: 'wolframscript' is not installed or not in PATH."
  exit 1
fi

# Supported output file extensions
OUTPUT_EXTENSIONS=(".hxx" ".cxx" ".c" ".h")

# Process each file passed as an argument
for input_file in "$@"; do
  # Ensure the file exists
  if [[ ! -f "$input_file" ]]; then
    echo "Warning: File '$input_file' does not exist. Skipping."
    continue
  fi

  # Remove .wl extension to form the base name
  base_name="${input_file%.wl}"

  # Run wolframscript on the input file
  [[ "$QUIET" != "1" ]] && echo "Processing '$input_file'..."
  if ! wolframscript -f "$input_file"; then
    echo "Error: Failed to process '$input_file'. Skipping output cleanup."
    continue
  fi

  # Check for any supported output file extensions and clean them
  found_output=false
  for ext in "${OUTPUT_EXTENSIONS[@]}"; do
    output_file="${base_name}${ext}"
    if [[ -f "$output_file" ]]; then
      found_output=true
      # Remove trailing spaces from the output file
      [[ "$QUIET" != "1" ]] && echo "Removing trailing spaces in '$output_file'..."
      sed -i.bak -E 's/[[:space:]]+$//' "$output_file" && rm "${output_file}.bak"
    fi
  done

  if [[ "$found_output" == false ]]; then
    echo "Warning: No output file found for '$input_file' (checked: ${OUTPUT_EXTENSIONS[*]})"
  fi

  [[ "$QUIET" != "1" ]] && echo
done

[[ "$QUIET" != "1" ]] && echo "DONE."
exit 0
